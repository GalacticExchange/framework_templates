echo "Waiting for VPN" >> /tmp/INIT_LOG

while  [ ! "/sbin/ifconfig tun0" ];
do
    sleep 0.1
    echo "waiting for the net..."
done


service ssh start

#todo move to firstrun
chmod +x /opt/gex/healthcheck

<% if @_components.include?('hdfs')%>
echo "HDFS datanode" >> /tmp/INIT_LOG
service hadoop-hdfs-datanode start
<% end %>


<% if @_components.include?('yarn') %>
echo "Yarn nodemanager" >> /tmp/INIT_LOG
service hadoop-yarn-nodemanager start
<% end %>

export  KAFKA_HEAP_OPTS="-Xmx50M -Xms50M"
<% if @_components.include?('kafka')%>
echo "Kafka" >> /tmp/INIT_LOG
/usr/bin/kafka-server-start /etc/kafka/kafka.server.properties &
<% end %>


chmod 0755 /usr/local/nifi/bin/nifi.sh
<% if @_components.include?('nifi') %>
echo "Nifi" >> /tmp/INIT_LOG
/usr/local/nifi/bin/nifi.sh start
<% end %>


<% if @_components.include?('cassandra') %>
echo "Cassandra" >> /tmp/INIT_LOG
service cassandra start
<% end %>

chmod 0755 /etc/init.d/elasticsearch
chmod 0755 /etc/init.d/kibana
<% if @_components.include?('elasticsearch') %>

echo "elasticsearch" >> /tmp/INIT_LOG
service elasticsearch start


echo "Kibana" >> /tmp/INIT_LOG
service kibana start

<% end %>


echo "Hue" >> /tmp/INIT_LOG
service hue start


<% if @_components.include?('spark') %>
echo "Spark worker" >> /tmp/INIT_LOG
/usr/lib/spark/sbin/start-slave.sh &
<% end %>


chmod 0755 /usr/bin/neo4j
mkdir -p /var/run/neo4j
<% if @_components.include?('neo4j') %>
echo "Neo4j" >> /tmp/INIT_LOG
/usr/bin/neo4j start
<% end %>

#echo "Nifi template" >> /tmp/INIT_LOG
#ruby /usr/local/nifi/add_template.rb &

# ENTERPRISE service impala-server start
# ENTERPRISE service solr-server start

# ENTERPRISE sudo oozie-setup sharelib create -fs localhost:8020 -locallib /usr/lib/oozie/oozie-sharelib-yarn.tar.gz
#service flume-ng-agent start

#XXXX temporarily removed sudo -u spark hadoop fs -put /usr/lib/spark/lib/spark-assembly.jar /user/spark/share/lib/spark-assembly.jar





